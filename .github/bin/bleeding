#!/bin/sh

SHA=$1
DATE=$2

if [ -z "$SHA" ] || [ -z "$DATE" ] ; then
  echo "Usage: .github/bin/bleeding SHA DATE"
  exit 1
fi

# Install Weblate from main branch
sed -i \
    -e "s/\\(ENV WEBLATE_VERSION .*\\)/\\1+$( date --date "$DATE" -I )/" \
    -e "/ENV WEBLATE_VERSION/a \
    ENV WEBLATE_DOCKER_GIT_REVISION $SHA" \
    -e "/LABEL org.opencontainers.image.version/a \
    LABEL org.opencontainers.image.revision=\"$SHA\"" \
    Dockerfile

# Adjust requirements for bleeding by removing ones we install from Git
# TODO: Drop in Weblate 5.0: pyparsing/tesserocr/selenium/responses
sed -i \
    -e 's/^pyparsing==3.0.9/pyparsing==3.1.1/' \
    -e 's/^tesserocr==2.6.0/tesserocr==2.6.1/' \
    -e '/^responses==0.23.1/ D' \
    -e '/^selenium==4.10.0/ D' \
    -e '/^translate-toolkit==/ D' \
    -e '/^weblate-language-data==/ D' \
    requirements.txt

# Consistent timestamp
touch --date="$DATE" Dockerfile

cat Dockerfile

# Remove patches
find patches -name '*.patch' -delete
